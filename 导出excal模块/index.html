<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" type="text/css" href="http://127.0.0.1:8020/H%2b/css/bootstrap.min.css?v=3.3.6"/>
		<link rel="stylesheet" type="text/css" href="http://127.0.0.1:8020/H%2b/css/font-awesome.css?v=4.4.0"/>
		<link rel="stylesheet" type="text/css" href="http://127.0.0.1:8020/H%2b/css/style.css?v=4.1.0"/>
		<link rel="stylesheet" type="text/css" href="http://127.0.0.1:8020/H%2b/css/animate.css"/>
		<style>
			body{
				height: 100vh;
				line-height: 100vh;
				text-align: center;
			}
			body>div{
				text-align: left;
				line-height: 1;
			}
			.log{
				position: fixed;top:0;
				left: 0;
				width: 200px;
				height: 200px;
				overflow: hidden;
				z-index: 999999999999999;
				overflow-y: auto;
				border: 1px solid #000;
				background: #ffff;
				opacity: .9;
				padding: 5px;
				text-align: left;
				line-height: 1;
			}
			.log p{
				margin-top: 5px;
			}
		</style>
	</head>
	<body>
		<div class='log'>
			<div>
				<p>流程</p>
			</div>
		</div>
		<div class="container" style="width: 600px; margin: 100px auto;" >
			<div class="form-group">
				<label class="col-sm-4 control-label" style='padding-top: 7px;'>数据数量</label>
		        <div class="col-sm-6">
                	<input type="text" id="count" placeholder="count" value='10' class="form-control"/>
                </div> 	
	
			</div>
			<br /><br />
			<div class="form-group">
				<label class="col-sm-4 control-label" style='padding-top: 7px;'>后台返回</label>
		        <div class="col-sm-6">
		        	<select class="form-control m-b" name="account" id="index">
                        <option value="0" selected="selected">可以下载</option>
                		<option value="1">先验证</option>
                		<option value="2">不可以下载</option>
                   </select>
                   <p>验证成功10秒后失效得重新验证</p>
               </div> 	
			</div>
			<div class="text-center">
				<button class="btn btn-success " type="button" id="export1"><i class="fa fa-cloud-download"></i>&nbsp;&nbsp;<span class="bold">业务数据</span></button>
				<button class="btn btn-success " type="button" id="export2"><i class="fa fa-cloud-download"></i>&nbsp;&nbsp;<span class="bold">销售数据</span></button>

			</div>
		</div>
		
        </button>
	    <script class="modalTemp" type="text/html">
	    	<div class="modal shake animated" tabindex="-1" >
		        <!--申明层-->
		        <div class="modal-dialog">
		            <div class="modal-content" >
		                <div class="export_verification">
		                	<div class="modal-header">
			                    <h4 class=" modal-title"><strong>验证手机</strong>
			                    <button class="close pull-right" style="padding: 0;" data-dismiss="modal">&times;</button></h4>
			                </div>
			                <div class="modal-body">
			                	<h5 class="m-b"><i class="fa fa-info-circle text-info" ></i>&nbsp;&nbsp;校验码已经发送到你的手机，请尽快输入</h5>
			                	<div class="form-horizontal col-xs">
			                		<div class="form-group">
		                                <label class="col-sm-4 control-label">手机号</label>
		                                <div class="col-sm-8">
		                                    <p class="form-control-static"></p>
		                                </div>
		                            </div>
		                            <div class="form-group">
		                                <label class="col-sm-4 control-label">验证码</label>
		                                <div class="col-sm-6">
		                                	<div class="input-group">
			                                    <input type="text" name="code" class="form-control"><span class="input-group-btn"> 
			                                    <button type="button" class="btn btn-default export_code_reset"></button> 
			                                    </span>
			                                </div>
			                                 <span class="help-block m-b-none"><i class="fa fa-check text-success" ></i>&nbsp;&nbsp;校验码已发送，请注意查收</span>
		                                </div> 		                                
		                            </div>
		                            <div class="text-center">
		                            	<button class="btn btn-primary export_code_send" type="button"><i class="fa fa-check"></i>&nbsp;提交</button>
		                            </div>
			                	</div>
			                </div>
		                </div> 	                
		            </div>
		        </div>
		    </div>
	    </script>
	    <script class="modalTemp" type="text/html">
	    	<div class="modal fade" tabindex="-1">
		        <!--申明层-->
		        <div class="modal-dialog">
		            <div class="modal-content" >	               
		                <div class="export_load">
			                <div class="modal-body">
			                	<h3 class="text-center"></h3>
			                	<div class="spiner-example">
		                            <div class="sk-spinner sk-spinner-wave" >
		                                <div class="sk-rect1"></div>
		                                <div class="sk-rect2"></div>
		                                <div class="sk-rect3"></div>
		                                <div class="sk-rect4"></div>
		                                <div class="sk-rect5"></div>
		                            </div>
		                        </div>
			                </div>
		                </div>
		            </div>
		        </div>
		    </div>
	    </script>
		<script src="http://127.0.0.1:8020/H%2b/js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="http://127.0.0.1:8020/H%2b/js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="https://crmdev.danongchang.cn/js/mock.js"></script>
		<!--Blob兼容-->
	    <script src="js/Blob.js"></script>
	    <!--//下载文件功能js-->
	    <script src="js/FileSaver.js"></script>		
		<!--//为ECMAScript 5 兼容性-->
		<script src="js/shim.min.js"></script>
		<!--//生成excal-->
   		 <script src="js/xlsx.full.min.js"></script>

		<script src="njtExportExcel.js" type="text/javascript" charset="utf-8"></script>		
		<script>
			
			$(function(){
				$('#export1').njtExportExcel({
					ExportAjax:function(){
						return {
			    			data:{
			    				action:'业务数据',
			    				count:$('#count').val()
			    			}
			    		}
					},
		    		err:function(data){
		    			alert(data.ErrorMessage);
		    		},
		    		ExcelName:'业务数据'
				})
				$('#export2').njtExportExcel({
					ExportAjax:function(){
						return {
			    			data:{
			    				action:'销售数据',
			    				count:$('#count').val()
			    			}
			    		}
					},
		    		err:function(data){
		    			alert(data.ErrorMessage);
		    		},
		    		ExcelName:'销售数据'
				});
			});
			
				
			function log(){
				var data = arguments;
				
				var $P = $('<p></p>');

				if(data.length==1){
					console.log(data[0])
					$P.append(data[0]);
				}else{
					console.log(data[0])
					console.log(data[1])
					$P.append(data[0]+'<br>');
					for (x in data[1]) {
						$P.append('---'+x+':'+data[1][x]+'<br>');
					}
				}
				$('.log div').append($P);
				$('.log').scrollTop($('.log div').height());
			}
			
			var Api = {
		        IsVerification: function (callback,msg) {  
		        	log('发起导出请求---->1秒后有返回值')		
					log('请求参数',msg)		       
		        	var arr = [{
		                    Code: 0,
		                    ErrorMessage: "不需要",
		                    ExtraJsonReturn: ''
		                },{
		                    Code: 2,
		                    ErrorMessage: "需要验证",
		                    ExtraJsonReturn: {
		                    	'tel|13000000000-14000000000':1
		                    }		                   
		                },{
		                    Code: 3,
		                    ErrorMessage: "没有权限",
		                    ExtraJsonReturn:''
		                }]
		        	//var index = Math.floor((Math.random()*arr.length)); 
					var index = $('#index').val();
					
		        	if(window.VerificationCode){
		        		index = 0;
		        		console.log('可以下载了')
		        	}

					var obj = arr[index];

					if(msg.action&&index==0){
						var data = [];
						var fileds = [
							'报表类型',
							'名字',
							'电话',
							'时间',
							'位置',
							'图片'
						];
						for (var i=0;i<msg.count;i++) {
							data.push({
								'报表类型':msg.action,
								 '名字':'@name',								
								 '电话|13000000000-14000000000':1,
								  '时间':'@time',
								 '图片':"@image('200x100', '#00405d', '#FFF', 'Mock.js')",
								 '位置':'@province@city@county'
							})
						}
						data = Mock.mock(data); 
						var newdata = [];
						newdata.push(fileds);
						data.forEach(function(item){
							var arr = [];
							fileds.forEach(function(filed){
								arr.push(item[filed]);								
							});
							newdata.push(arr);
						});
						obj.ExtraJsonReturn = newdata;
					}
		           setTimeout(function(){
		           	   Mock.mock('http://IsVerification', obj);
		           	   callback();
		           	    setTimeout(function(){		           	 
			           	   if(obj.Code == 2){
			           	   		Api.creatCode('已生成验证码-->');
			           	   }
			           },500);	
		           },1000);		           
		        },
		        creatCode:function(msg){
		        	window.VerificationCode = Mock.mock({'code|1000-9999':1}).code;	
		        	log(msg+VerificationCode)
		        	
		        },
		        sendCode:function(msg,callback){
		        	var obj = {};
		        	if(msg.code == VerificationCode){
		        		obj = {
		                    Code: 0,
		                    ErrorMessage: "填写正确",
		                    ExtraJsonReturn: ''
		                }
		        		
		        	}else{
		        		obj = {
		                    Code: 2,
		                    ErrorMessage: "填写错误",
		                    ExtraJsonReturn: ''
		                }
		        	}	
		        	Mock.mock('http://sendCode', obj);
		        	 setTimeout(function(){
		           	 	Mock.mock('http://sendCode', obj);
		           	   callback();
		           	   log('验证成功10秒后失效得重新验证')
						setTimeout(function(){		           	 
		           	   		window.VerificationCode = null;
		           	   		log('验证失效了')
			           },10000);	
		            },1000);		
		        }
		    };
		</script>
	</body>
</html>
